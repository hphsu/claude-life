# 命理分析系統技術規格 (Fortune-Telling System Specification)

## 📋 專案概述

**目標**: 創建基於 Claude Code 的專業命理分析系統，整合八字、紫微斗數、占星三種方法，提供跨方法綜合解讀。

**語言**: 繁體中文輸出
**使用對象**: 個人使用
**準確度**: 專業級（真太陽時校正、精確天文計算）
**部署方式**: Claude Code 自定義命令

---

## 🏗️ 系統架構

### 整體流程

```
/fortune-tell [出生資訊] [選項]
    ↓
1. 主命令處理器 (Main Command Handler)
    ↓
2. 輸入解析與驗證 (Input Parser & Validator)
    ↓
3. 曆法轉換引擎 (Calendar Converter - Python)
    ├─ 公曆 → 農曆轉換
    ├─ 節氣時刻精確計算
    ├─ 真太陽時校正
    └─ 天文座標計算
    ↓
4. 平行代理執行 (Parallel Agent Execution via Task tool)
    ├─ 🔮 八字代理 (BaZi Agent)
    ├─ ⭐ 紫微代理 (Zi Wei Agent)
    └─ 🌟 占星代理 (Astrology Agent)
    ↓
5. 結果收集 (Results Collection)
    ↓
6. 綜合協調器 (Synthesis Coordinator)
    ├─ 跨方法概念映射
    ├─ 模式識別
    ├─ 一致性分析
    └─ 統一詮釋
    ↓
7. 報告生成器 (Report Generator)
    ├─ 繁體中文詳細分析
    ├─ 結構化章節
    └─ 視覺元素（表格、圖表）
    ↓
8. 檔案儲存系統 (File Storage)
    └─ claudedocs/fortune-readings/[姓名]-[生日]-[時間戳].md
```

---

## 🔧 技術組件規格

### 1. 命令結構 (Command Structure)

#### 基本語法
```bash
/fortune-tell --name <姓名> --date <YYYY-MM-DD> --time <HH:MM> --location <地點> --gender <男/女>
```

#### 完整參數
```bash
/fortune-tell \
  --name "張三" \
  --date 1990-05-15 \
  --time 14:30 \
  --location "台北" \
  --gender 男 \
  --accuracy professional \
  --include-transit \
  --save \
  --think-harder \
  --loop
```

#### 參數說明

| 參數 | 必填 | 說明 | 範例 |
|-----|------|-----|------|
| `--name` | 是 | 姓名（用於檔案命名） | "張三" |
| `--date` | 是 | 出生日期（公曆） | 1990-05-15 |
| `--time` | 是 | 出生時間（24小時制） | 14:30 |
| `--location` | 是 | 出生地點（用於時區計算） | "台北" |
| `--gender` | 是 | 性別（紫微排盤需要） | 男/女 |
| `--accuracy` | 否 | 準確度級別 | professional/standard (預設: professional) |
| `--include-transit` | 否 | 包含流年運勢分析 | 布林旗標 |
| `--compatibility` | 否 | 合婚配對（需提供第二人資訊） | [第二人JSON] |
| `--date-selection` | 否 | 擇日建議（需指定事項） | 事業/婚嫁/搬家/開業 |
| `--focus` | 否 | 聚焦特定面向 | 事業/感情/財運/健康 |
| `--save` | 否 | 儲存結果到檔案 | 布林旗標（預設啟用） |
| `--think-harder` | 否 | 深度分析模式（啟用 Sequential MCP） | 布林旗標 |
| `--loop` | 否 | 迭代精煉模式 | 布林旗標 |

#### 互動式輸入模式 (Interactive Input Mode)

**觸發條件**: 當用戶執行 `/fortune-tell` 但未提供任何參數時

**設計理念**: 提供友善的互動式體驗，逐步引導用戶輸入所需資訊

##### 互動流程設計

```markdown
用戶執行: /fortune-tell

→ 系統回應:

## 🔮 命理分析系統

歡迎使用專業命理分析系統！我將整合**八字**、**紫微斗數**、**占星**三種方法，為您提供全面的命理解讀。

為了進行分析，我需要收集以下基本資訊：

### 📝 第一步：基本資料

**請提供以下資訊**（您可以一次提供全部，或我逐項詢問）：

1. **姓名**: ___________
2. **出生日期** (公曆): YYYY-MM-DD
3. **出生時間** (24小時制): HH:MM
4. **出生地點**: ___________
5. **性別**: 男 / 女

---

**快速輸入範例**:
```
張三, 1990-05-15, 14:30, 台北, 男
```

或者，您也可以說「開始」，我將逐項詢問。
```

##### 逐項詢問流程

**模式 1: 用戶一次性提供**
```
用戶: 張三, 1990-05-15, 14:30, 台北, 男

系統:
✅ 已收集基本資料：
- 姓名: 張三
- 出生日期: 1990年5月15日
- 出生時間: 14:30
- 出生地點: 台北
- 性別: 男

### 📊 第二步：分析選項（可選）

您希望包含哪些進階分析？

1. 🔄 **流年運勢** - 分析當前年份的運勢變化
2. 💑 **合婚配對** - 與另一人的契合度分析（需額外提供對方資訊）
3. 🗓️ **擇日選時** - 為特定事項選擇吉日良辰
4. 🎯 **聚焦分析** - 針對特定面向深入分析（事業/感情/財運/健康）

請選擇編號（可多選，用逗號分隔），或直接說「開始分析」跳過：
```

**模式 2: 逐項詢問**
```
用戶: 開始

系統:
好的，讓我逐步收集資訊。

### 1️⃣ 請問您的姓名是？
（用於檔案命名和個人化分析）

用戶: 張三

系統:
✅ 姓名: 張三

### 2️⃣ 請提供您的出生日期（公曆）
格式: YYYY-MM-DD 或 西元年-月-日
例如: 1990-05-15

用戶: 1990-05-15

系統:
✅ 出生日期: 1990年5月15日（農曆：庚午年 四月二十一）

### 3️⃣ 請提供出生時間（24小時制）
格式: HH:MM
例如: 14:30 (下午2點30分)

⚠️ **重要**: 出生時間對八字和紫微斗數的準確性至關重要。
如果不確定精確時間，可以：
- 提供大概時段（例如：下午2點到3點之間）
- 我會使用時段中點進行分析

用戶: 14:30

系統:
✅ 出生時間: 14:30（未時）

### 4️⃣ 請提供出生地點
例如: 台北、高雄、台中
或更精確: 台北市中正區

📍 **說明**: 出生地點用於時區計算和真太陽時校正，影響時辰判定準確性。

用戶: 台北

系統:
✅ 出生地點: 台北（時區: UTC+8, 東經121.5°）

### 5️⃣ 請問您的性別？
選項: 男 / 女

📝 **說明**: 性別用於紫微斗數的大限排列（男女順逆不同）。

用戶: 男

系統:
✅ 性別: 男

---

🎉 **基本資料收集完成！**

**您的資料摘要**:
- 👤 姓名: 張三
- 📅 出生: 1990年5月15日 14:30
- 📍 地點: 台北
- ⚧ 性別: 男

### 📊 進階選項

您希望包含哪些進階分析？（可選）

1. 🔄 **流年運勢** - 分析2025年的運勢
2. 💑 **合婚配對** - 需提供對方資訊
3. 🗓️ **擇日選時** - 為特定事項選日子
4. 🎯 **聚焦分析** - 深入特定面向
5. 🧠 **深度分析** - 啟用 --think-harder 模式
6. 🔄 **迭代優化** - 啟用 --loop 模式

請輸入選項編號（多選用逗號分隔，例如: 1,5,6），或直接說「開始分析」：
```

##### 進階選項互動

**選項 1: 流年運勢**
```
用戶: 1

系統:
已選擇「流年運勢分析」

請問要分析哪一年？（直接輸入年份，或說「今年」）

用戶: 今年

系統:
✅ 將分析 2025年 的流年運勢
```

**選項 2: 合婚配對**
```
用戶: 2

系統:
已選擇「合婚配對分析」

請提供對方的資訊（格式同上）：
- 姓名: ___________
- 出生日期: YYYY-MM-DD
- 出生時間: HH:MM
- 出生地點: ___________
- 性別: 男/女

快速輸入範例:
李四, 1991-08-20, 10:15, 高雄, 女

用戶: 李四, 1991-08-20, 10:15, 高雄, 女

系統:
✅ 對方資料已收集
將進行雙方命盤配對分析
```

**選項 3: 擇日選時**
```
用戶: 3

系統:
已選擇「擇日選時」

請問是為了什麼事項選日子？

常見選項:
1. 💼 創業開業
2. 💒 婚嫁迎娶
3. 🏠 搬家入宅
4. ✈️ 出行遠行
5. 📝 簽約合作
6. 其他（請說明）

用戶: 1

系統:
✅ 將為「創業開業」提供擇日建議

希望在哪個時間範圍內？（例如: 未來3個月、2025年6月）

用戶: 未來3個月

系統:
✅ 將在2025年11月-2026年1月範圍內尋找吉日
```

**選項 4: 聚焦分析**
```
用戶: 4

系統:
已選擇「聚焦分析」

請選擇您最關心的面向：

1. 💼 事業發展
2. 💕 感情婚姻
3. 💰 財富運勢
4. 🏥 健康狀況
5. 🎓 學業考試
6. 👨‍👩‍👦 家庭關係

可多選（用逗號分隔）：

用戶: 1,3

系統:
✅ 將重點分析「事業發展」和「財富運勢」
```

##### 確認與開始分析

```
系統:
---

## 📋 最終確認

**基本資料**:
- 👤 張三
- 📅 1990-05-15 14:30
- 📍 台北
- ⚧ 男

**分析選項**:
- ✅ 流年運勢（2025年）
- ✅ 深度分析模式
- ✅ 迭代優化模式

**預計分析時間**: 約3-5分鐘

確認以上資訊無誤？
- 輸入「確認」或「開始」開始分析
- 輸入「修改」重新設定某項資料
- 輸入「取消」結束

用戶: 確認

系統:
🚀 **開始分析！**

正在啟動專業命理分析系統...

⏳ 進度:
1. ✅ 曆法轉換完成（公曆→農曆）
2. 🔄 計算八字四柱...
3. 🔄 排紫微命盤...
4. 🔄 計算占星星盤...

[繼續正常的分析流程...]
```

##### 錯誤處理與驗證

**日期驗證**
```
用戶: 1990-13-40

系統:
❌ 日期格式錯誤：不存在的月份或日期

請重新輸入正確的日期（格式: YYYY-MM-DD）：
例如: 1990-05-15

如果不確定，可以輸入「不知道」，我會提供其他方案。
```

**時間驗證**
```
用戶: 25:70

系統:
❌ 時間格式錯誤：請使用24小時制（00:00-23:59）

請重新輸入出生時間：
例如: 14:30 (下午2點30分)

💡 **提示**:
- 如果只知道大概時段，可以這樣說：
  「下午2點到3點之間」
  「早上」
  「晚上」
```

**地點驗證**
```
用戶: xyz

系統:
⚠️ 無法識別的地點

請提供台灣或中國的城市名稱，例如:
- 台灣: 台北、台中、高雄、新竹...
- 中國: 北京、上海、廣州、深圳...

或者提供更具體的資訊：
- 完整地址
- 經緯度座標

如果在國外出生，請說明國家和城市。
```

##### 簡化版互動（快速模式）

```
用戶: /fortune-tell

系統:
## 🔮 命理分析系統

請提供基本資訊（一次輸入即可）：

**格式**: 姓名, 生日(YYYY-MM-DD), 時間(HH:MM), 地點, 性別

**範例**: 張三, 1990-05-15, 14:30, 台北, 男

或輸入「詳細」進入逐步引導模式 →

用戶: [快速輸入或選擇詳細模式]
```

##### 實現優先級

**Phase 1 (MVP)**:
- ✅ 基本參數解析
- ✅ 簡單的「無參數 → 提示使用方式」

**Phase 2**:
- ✅ 完整的逐項詢問流程
- ✅ 基本驗證與錯誤處理

**Phase 3**:
- ✅ 進階選項互動
- ✅ 智能提示與建議
- ✅ 歷史記錄快速選擇（記住之前分析過的人）

---

### 2. Python 計算引擎 (Calculation Engine)

#### 檔案結構
```
scripts/fortune-telling/
├── __init__.py
├── calendar_converter.py      # 曆法轉換核心
├── bazi_calculator.py          # 八字計算
├── ziwei_calculator.py         # 紫微計算
├── astrology_calculator.py     # 占星計算
├── utils.py                    # 工具函數
└── requirements.txt            # Python 依賴
```

#### 依賴庫 (requirements.txt)
```txt
lunarcalendar>=3.0.0     # 農曆轉換
pytz>=2023.3             # 時區處理
ephem>=4.1.4             # 天文計算
pyswisseph>=2.10.3       # 瑞士星曆（專業占星）
python-dateutil>=2.8.2   # 日期處理
```

#### calendar_converter.py 核心功能
```python
"""
曆法轉換與天文計算模組
"""

class CalendarConverter:
    """專業級曆法轉換器"""

    def __init__(self):
        self.timezone_db = pytz  # 時區數據庫

    def gregorian_to_lunar(self, year, month, day, hour, minute, location):
        """
        公曆轉農曆（含節氣精確計算）

        Args:
            year, month, day: 公曆日期
            hour, minute: 出生時間
            location: 出生地點（用於時區判斷）

        Returns:
            dict: {
                'lunar_year': int,      # 農曆年
                'lunar_month': int,     # 農曆月
                'lunar_day': int,       # 農曆日
                'lunar_hour': str,      # 時辰（子丑寅卯...）
                'solar_term': str,      # 所屬節氣
                'true_solar_time': datetime,  # 真太陽時
                'timezone_offset': float,     # 時區偏移
            }
        """
        pass

    def calculate_solar_terms(self, year):
        """計算全年24節氣精確時刻"""
        pass

    def adjust_true_solar_time(self, datetime_obj, longitude):
        """真太陽時校正（考慮地方經度）"""
        pass

    def get_timezone_info(self, location):
        """根據地點獲取時區資訊"""
        pass
```

#### bazi_calculator.py 核心功能
```python
"""
八字命理計算模組
"""

class BaziCalculator:
    """八字四柱計算器"""

    def __init__(self, lunar_data):
        self.lunar_data = lunar_data

    def calculate_four_pillars(self):
        """
        計算四柱八字

        Returns:
            dict: {
                'year_pillar': {'stem': '庚', 'branch': '午'},
                'month_pillar': {'stem': '辛', 'branch': '巳'},
                'day_pillar': {'stem': '甲', 'branch': '寅'},
                'hour_pillar': {'stem': '辛', 'branch': '未'},
                'hidden_stems': {...},      # 地支藏干
                'ten_gods': {...},          # 十神配置
                'elements': {...},          # 五行統計
                'nayin': {...},             # 納音
                'day_master': '甲',         # 日主
                'strength': 'weak/strong',  # 身強/身弱
            }
        """
        pass

    def analyze_structure(self, four_pillars):
        """格局分析（財官印食等格局判斷）"""
        pass

    def calculate_luck_pillars(self, gender):
        """大運計算"""
        pass

    def analyze_annual_fortune(self, current_year):
        """流年分析"""
        pass
```

#### ziwei_calculator.py 核心功能
```python
"""
紫微斗數計算模組
"""

class ZiweiCalculator:
    """紫微斗數排盤計算器"""

    def __init__(self, lunar_data, gender):
        self.lunar_data = lunar_data
        self.gender = gender

    def calculate_natal_chart(self):
        """
        排紫微命盤

        Returns:
            dict: {
                'life_palace': {...},      # 命宮
                'sibling_palace': {...},   # 兄弟宮
                'spouse_palace': {...},    # 夫妻宮
                'children_palace': {...},  # 子女宮
                'wealth_palace': {...},    # 財帛宮
                'health_palace': {...},    # 疾厄宮
                'travel_palace': {...},    # 遷移宮
                'friends_palace': {...},   # 僕役宮（交友）
                'career_palace': {...},    # 官祿宮（事業）
                'property_palace': {...},  # 田宅宮
                'fortune_palace': {...},   # 福德宮
                'parents_palace': {...},   # 父母宮
                'major_stars': [...],      # 主星列表
                'minor_stars': [...],      # 輔星列表
                'four_transformations': {...},  # 四化（祿權科忌）
            }
        """
        pass

    def place_major_stars(self):
        """安主星（紫微、天機、太陽...）"""
        pass

    def place_minor_stars(self):
        """安輔星（文昌、文曲、左輔、右弼...）"""
        pass

    def calculate_four_transformations(self):
        """計算四化飛星"""
        pass

    def analyze_major_limits(self):
        """大限分析"""
        pass
```

#### astrology_calculator.py 核心功能
```python
"""
占星學計算模組（西洋占星）
"""

import swisseph as swe

class AstrologyCalculator:
    """占星命盤計算器"""

    def __init__(self, birth_datetime, latitude, longitude):
        self.birth_datetime = birth_datetime
        self.latitude = latitude
        self.longitude = longitude

    def calculate_natal_chart(self):
        """
        計算本命星盤

        Returns:
            dict: {
                'sun': {'sign': '金牛座', 'degree': 24.5, 'house': 10},
                'moon': {'sign': '巨蟹座', 'degree': 12.3, 'house': 1},
                'mercury': {...},
                'venus': {...},
                'mars': {...},
                'jupiter': {...},
                'saturn': {...},
                'uranus': {...},
                'neptune': {...},
                'pluto': {...},
                'ascendant': {'sign': '處女座', 'degree': 5.2},
                'mc': {'sign': '雙子座', 'degree': 15.8},
                'houses': [...],        # 十二宮位
                'aspects': [...],       # 相位列表
                'dominant_element': str,  # 主導元素
                'chart_pattern': str,   # 星盤格局
            }
        """
        pass

    def calculate_planets(self):
        """計算行星位置（使用 Swiss Ephemeris）"""
        pass

    def calculate_houses(self):
        """計算宮位（使用 Placidus 分宮法）"""
        pass

    def calculate_aspects(self):
        """計算行星相位（合、沖、拱、刑等）"""
        pass

    def analyze_transits(self, target_date):
        """流年行運分析"""
        pass
```

---

### 3. 專業代理規格 (Specialized Agents)

#### 3.1 八字代理 (BaZi Agent)

**角色定位**: 精通子平八字、滴天髓、窮通寶鑑的八字命理專家

**輸入**: Python 計算引擎提供的四柱數據

**專業領域**:
- 四柱排盤與五行分析
- 十神配置與格局判斷
- 用神喜忌分析
- 大運流年推演
- 事業財運健康解讀

**輸出格式**:
```markdown
## 🔮 八字命理分析

### 一、基本命盤

**四柱八字**:
| 年柱 | 月柱 | 日柱 | 時柱 |
|------|------|------|------|
| 庚午 | 辛巳 | 甲寅 | 辛未 |
| 天干 | 天干 | 天干 | 天干 |
| 地支 | 地支 | 地支 | 地支 |

**五行統計**:
- 木: 2 | 火: 3 | 土: 1 | 金: 3 | 水: 0
- **五行特徵**: 缺水，火旺金旺

**日主**: 甲木
**身強弱**: 身弱（火土金旺洩耗日主）
**用神**: 水（生身）、木（比助）
**喜神**: 水木
**忌神**: 火土金

### 二、格局分析

**主格局**: [具體格局名稱]
**格局成敗**: [成格/破格分析]
**取用原則**: [用神選取依據]

### 三、十神配置

**十神分佈**:
- 比肩劫財: [數量與位置]
- 食神傷官: [數量與位置]
- 正財偏財: [數量與位置]
- 正官偏官: [數量與位置]
- 正印偏印: [數量與位置]

**十神特性解讀**:
[基於十神配置的性格與命運特徵分析]

### 四、命運特徵

#### 💼 事業運勢
[官星、印星、食傷配置分析]

#### 💰 財富運勢
[財星強弱、財格成敗分析]

#### 💕 感情婚姻
[配偶宮、桃花星、官殺財星分析]

#### 🏥 健康狀況
[五行偏枯、病符神煞分析]

### 五、大運流年

**大運排列**:
[10年一運的天干地支配置與起運年齡]

**流年重點**:
[當前與未來重要年份的運勢變化]

### 六、開運建議

**五行補救**: [根據用神提供的調整方向]
**方位選擇**: [有利方位]
**顏色建議**: [有利顏色]
**職業方向**: [適合的行業類型]
```

#### 3.2 紫微代理 (Zi Wei Agent)

**角色定位**: 精通紫微斗數全書、中州派紫微的紫微命理專家

**輸入**: Python 計算引擎提供的十二宮數據

**專業領域**:
- 十二宮星曜配置
- 主星輔星組合解讀
- 四化飛星分析
- 大限流年推演
- 人生各階段運勢

**輸出格式**:
```markdown
## ⭐ 紫微斗數分析

### 一、命盤概況

**基本資料**:
- 命宮主星: [星曜名稱]
- 身宮位置: [宮位]
- 命主: [星曜]
- 身主: [星曜]

**十二宮星曜配置圖**:
```
巳    午    未    申
[宮位] [宮位] [宮位] [宮位]

辰              酉
[宮位]          [宮位]

卯              戌
[宮位]          [宮位]

寅    丑    子    亥
[宮位] [宮位] [宮位] [宮位]
```

### 二、命宮分析

**命宮主星**: [主星名稱與組合]
**星曜特性**: [主星性格特質]
**格局**: [特殊格局名稱，如「君臨天下」、「財蔭夾印」等]

### 三、十二宮詳解

#### 🌟 命宮 - 性格與命運主軸
[星曜配置與詳細解讀]

#### 👥 兄弟宮 - 手足與平輩關係
[星曜配置與詳細解讀]

#### 💑 夫妻宮 - 婚姻與感情
[星曜配置與詳細解讀]

#### 👶 子女宮 - 子嗣與創造力
[星曜配置與詳細解讀]

#### 💰 財帛宮 - 財運與理財
[星曜配置與詳細解讀]

#### 🏥 疾厄宮 - 健康與疾病
[星曜配置與詳細解讀]

#### 🌍 遷移宮 - 外出與變動
[星曜配置與詳細解讀]

#### 🤝 僕役宮 - 朋友與部屬
[星曜配置與詳細解讀]

#### 💼 官祿宮 - 事業與地位
[星曜配置與詳細解讀]

#### 🏠 田宅宮 - 不動產與家庭
[星曜配置與詳細解讀]

#### 😊 福德宮 - 精神與享受
[星曜配置與詳細解讀]

#### 👨‍👩‍👦 父母宮 - 父母與長輩
[星曜配置與詳細解讀]

### 四、四化分析

**生年四化**:
- 祿: [飛入宮位與影響]
- 權: [飛入宮位與影響]
- 科: [飛入宮位與影響]
- 忌: [飛入宮位與影響]

**四化效應**: [四化對命局的整體影響]

### 五、大限流年

**大限走勢**: [每十年大限的宮位與運勢]
**流年重點**: [當前與近期流年的運勢變化]

### 六、人生建議

[基於命盤配置的發展方向與注意事項]
```

#### 3.3 占星代理 (Astrology Agent)

**角色定位**: 精通現代西洋占星、心理占星的占星專家

**輸入**: Python 計算引擎提供的星盤數據

**專業領域**:
- 本命星盤解讀
- 行星星座宮位分析
- 相位配置解讀
- 流年行運分析
- 心理特質與天賦

**輸出格式**:
```markdown
## 🌟 占星命盤分析

### 一、星盤概覽

**核心配置**:
- ☉ 太陽: [星座] 第[X]宮 [度數]
- ☽ 月亮: [星座] 第[X]宮 [度數]
- ↑ 上升: [星座] [度數]
- ☊ 中天(MC): [星座] [度數]

**主導元素**: [火/土/風/水] 元素 ([比例])
**主導模式**: [基本/固定/變動] 模式 ([比例])
**星盤格局**: [T型三角、大三角、風箏等特殊格局]

### 二、行星配置

#### ☉ 太陽 - 自我與生命力
- **位置**: [星座] 第[X]宮
- **意義**: [核心自我表達與人生目標]

#### ☽ 月亮 - 情感與需求
- **位置**: [星座] 第[X]宮
- **意義**: [情感模式與內在需求]

#### ☿ 水星 - 思考與溝通
- **位置**: [星座] 第[X]宮
- **意義**: [思維方式與溝通風格]

#### ♀ 金星 - 愛與價值
- **位置**: [星座] 第[X]宮
- **意義**: [愛情觀與審美品味]

#### ♂ 火星 - 行動與慾望
- **位置**: [星座] 第[X]宮
- **意義**: [行動力與欲望表達]

#### ♃ 木星 - 擴展與幸運
- **位置**: [星座] 第[X]宮
- **意義**: [成長領域與機遇方向]

#### ♄ 土星 - 限制與責任
- **位置**: [星座] 第[X]宮
- **意義**: [考驗領域與成熟方向]

#### ♅ 天王星 - 變革與創新
- **位置**: [星座] 第[X]宮
- **意義**: [突破領域與獨特性]

#### ♆ 海王星 - 夢想與靈性
- **位置**: [星座] 第[X]宮
- **意義**: [理想追求與靈性發展]

#### ♇ 冥王星 - 轉化與重生
- **位置**: [星座] 第[X]宮
- **意義**: [深層轉化與權力議題]

### 三、宮位重點

[針對有行星落入或重要的宮位進行詳細解讀]

### 四、相位分析

**主要相位**:
- [行星1] [相位符號] [行星2]: [相位意義與影響]
- [更多相位...]

**相位格局**: [特殊相位組合的整體影響]

### 五、生命主題

#### 💼 事業與成就
[第十宮、土星、太陽相關分析]

#### 💰 財富與資源
[第二宮、第八宮、金星、木星相關分析]

#### 💕 愛情與關係
[第七宮、金星、火星、月亮相關分析]

#### 🧘 靈性與成長
[第九宮、第十二宮、海王星相關分析]

### 六、流年行運

**當前重要行運**:
[外行星對本命盤的重要相位與影響]

**未來重點時期**:
[接下來幾年的重要占星事件]

### 七、天賦與挑戰

**天賦領域**: [基於吉相位與有力行星的分析]
**挑戰領域**: [基於凶相位與受剋行星的分析]
**整合建議**: [如何發揮天賦並克服挑戰]
```

---

### 4. 綜合協調器 (Synthesis Coordinator)

**角色定位**: 跨方法整合專家，精通三種命理系統的對應關係

**核心功能**:
1. 概念映射 (Concept Mapping)
2. 模式識別 (Pattern Recognition)
3. 一致性分析 (Convergence Analysis)
4. 綜合詮釋 (Unified Interpretation)

#### 概念映射表 (Concept Mapping Table)

| 命理面向 | 八字指標 | 紫微指標 | 占星指標 |
|---------|---------|---------|---------|
| **事業運** | 官星/印星/食傷<br>官格/印格 | 官祿宮星曜<br>武曲/天府/太陽 | 第十宮/MC<br>土星/太陽位置 |
| **財運** | 財星強弱<br>財格成敗 | 財帛宮星曜<br>武曲/天府/太陰 | 第二宮/第八宮<br>木星/金星 |
| **感情** | 配偶宮/桃花星<br>官殺/財星 | 夫妻宮星曜<br>紅鸞/天喜/廉貞貪狼 | 第七宮<br>金星/火星/月亮 |
| **健康** | 五行偏枯<br>病符神煞 | 疾厄宮星曜<br>煞星組合 | 第六宮<br>凶星刑沖 |
| **性格** | 日主強弱<br>十神配置 | 命宮主星<br>星曜組合 | 太陽/上升星座<br>個人行星配置 |
| **智慧** | 食傷/印星<br>水木旺相 | 文昌文曲<br>天機星 | 水星/第三宮<br>第九宮 |
| **人際** | 比劫配置<br>食傷生財 | 僕役宮/兄弟宮<br>天梁/天同 | 第十一宮<br>月亮/金星相位 |
| **家庭** | 父母宮/祖業 | 父母宮/田宅宮<br>天府/太陰 | 第四宮/第十宮<br>月亮/土星 |

#### 強度評分系統 (Strength Scoring)

每個命理面向根據三種方法給予強度評分（1-10分）：

```python
def calculate_strength_score(aspect, bazi_indicators, ziwei_indicators, astro_indicators):
    """
    計算特定命理面向的綜合強度

    Returns:
        dict: {
            'bazi_score': float (1-10),
            'ziwei_score': float (1-10),
            'astro_score': float (1-10),
            'average_score': float (1-10),
            'convergence': 'high/medium/low',  # 一致性程度
            'interpretation': str,  # 綜合解讀
        }
    """
    pass
```

#### 綜合報告輸出格式

```markdown
## 🧩 跨方法綜合分析

### 一、核心命運特徵

#### 🎯 三方一致的強力指標

**1. [命理面向名稱]**
- ✅ **八字**: [具體指標與評分 ⭐⭐⭐⭐⭐ 9/10]
- ✅ **紫微**: [具體指標與評分 ⭐⭐⭐⭐⭐ 9/10]
- ✅ **占星**: [具體指標與評分 ⭐⭐⭐⭐⭐ 8/10]
- 🌟 **綜合解讀**: [三者一致的結論與建議]

**2. [下一個面向]**
[同樣結構...]

#### ⚖️ 不同觀點的平衡說明

**[命理面向名稱]**
- 📊 **八字觀點**: [評分與說明]
- 📊 **紫微觀點**: [評分與說明]
- 📊 **占星觀點**: [評分與說明]
- 🤔 **差異分析**: [為何三種方法有不同解讀]
- 💡 **整合建議**: [如何平衡不同觀點]

### 二、人生階段運勢

| 年齡階段 | 八字大運 | 紫微大限 | 占星行運 | 綜合評估 |
|---------|---------|---------|---------|---------|
| 0-10歲 | [運勢] | [運勢] | [運勢] | [整合] |
| 11-20歲 | [運勢] | [運勢] | [運勢] | [整合] |
| 21-30歲 | [運勢] | [運勢] | [運勢] | [整合] |
| 31-40歲 | [運勢] | [運勢] | [運勢] | [整合] |
| 41-50歲 | [運勢] | [運勢] | [運勢] | [整合] |
| 51-60歲 | [運勢] | [運勢] | [運勢] | [整合] |

### 三、重要人生主題

#### 💼 事業發展路徑
[整合三種方法對事業的完整分析]

#### 💰 財富累積模式
[整合三種方法對財運的完整分析]

#### 💕 感情婚姻狀態
[整合三種方法對感情的完整分析]

#### 🏥 健康養生重點
[整合三種方法對健康的完整分析]

### 四、個人化建議

#### 🎯 優勢發揮
[基於三方一致的強項給予建議]

#### ⚠️ 風險規避
[基於三方一致的弱項給予提醒]

#### 🛤️ 發展路線
[整合性的人生規劃建議]

#### 🔮 關鍵時機
[重要的轉折年份與把握時機的建議]
```

---

### 5. 進階功能規格

#### 5.1 流年運勢分析 (`--include-transit`)

**功能**: 分析特定年份（預設當前年份）的運勢

**實現方式**:
- 八字: 計算流年天干地支與命盤的作用關係
- 紫微: 流年宮位飛化分析
- 占星: 外行星行運與本命盤的相位

**輸出格式**:
```markdown
## 📅 流年運勢分析 - [年份]

### 八字流年
- 流年干支: [天干地支]
- 與命局關係: [生剋制化]
- 吉凶判斷: [整體運勢評估]
- 重點月份: [特別好或壞的月份]

### 紫微流年
- 流年命宮: [宮位與星曜]
- 流年四化: [祿權科忌飛入位置]
- 重點宮位: [受影響最大的宮位]

### 占星流年
- 木星行運: [影響領域]
- 土星行運: [考驗領域]
- 外行星重要相位: [重大影響事件]

### 綜合流年運勢
[整合三種方法的年度運勢預測與建議]
```

#### 5.2 合婚配對分析 (`--compatibility`)

**功能**: 分析兩人命盤的契合度

**輸入**: 需提供第二人的完整出生資訊

**實現方式**:
- 八字: 五行配合、十神關係、用神互補
- 紫微: 夫妻宮互看、星曜配合
- 占星: 比較盤分析、合盤相位

**輸出格式**:
```markdown
## 💑 合婚配對分析

### 基本資料
- 甲方: [姓名] [出生資訊]
- 乙方: [姓名] [出生資訊]

### 八字配對
- 五行互補性: [評分與說明]
- 用神關係: [是否互補]
- 整體契合度: ⭐⭐⭐⭐ (4/5)

### 紫微配對
- 雙方命宮主星組合: [評估]
- 夫妻宮互看: [評估]
- 整體契合度: ⭐⭐⭐⭐ (4/5)

### 占星配對
- 太陽月亮相位: [評估]
- 金星火星配置: [評估]
- 整體契合度: ⭐⭐⭐⭐⭐ (5/5)

### 綜合配對評估
**總體契合度**: ⭐⭐⭐⭐ (4.3/5)

**優勢領域**: [雙方特別契合的面向]
**挑戰領域**: [需要磨合的面向]
**相處建議**: [如何維繫良好關係]
```

#### 5.3 擇日選時 (`--date-selection`)

**功能**: 為重要事項選擇吉日吉時

**輸入**: 事項類型（事業/婚嫁/搬家/開業等）

**實現方式**:
- 八字: 與命主喜用神配合的日子
- 紫微: 避開流日凶煞
- 占星: 選擇有利行星相位的時間

**輸出格式**:
```markdown
## 🗓️ 擇日建議 - [事項名稱]

### 最佳日期推薦

**第一選擇**: [YYYY-MM-DD] (星期X)
- 八字評估: ⭐⭐⭐⭐⭐
- 紫微評估: ⭐⭐⭐⭐⭐
- 占星評估: ⭐⭐⭐⭐
- 綜合說明: [為何這天特別適合]

**第二選擇**: [YYYY-MM-DD] (星期X)
[同樣結構...]

**第三選擇**: [YYYY-MM-DD] (星期X)
[同樣結構...]

### 建議時辰
- 最佳時辰: [X時 (HH:00-HH:59)]
- 次選時辰: [X時 (HH:00-HH:59)]

### 注意事項
[該日期需要注意的事項與禁忌]
```

#### 5.4 運勢追蹤 (長期記錄功能)

**功能**: 記錄歷史分析，支援長期追蹤

**實現方式**:
- 每次分析自動儲存到檔案
- 檔案命名包含時間戳
- 支援查詢歷史記錄

**檔案結構**:
```
claudedocs/fortune-readings/
├── [姓名]-[生日]/
│   ├── natal-chart-[timestamp].md          # 本命分析
│   ├── transit-[年份]-[timestamp].md       # 流年分析
│   ├── compatibility-[對方]-[timestamp].md # 合婚分析
│   └── date-selection-[事項]-[timestamp].md # 擇日記錄
└── index.md  # 總索引（自動更新）
```

---

### 6. 工作流程 (Workflow)

#### 完整執行流程

```
1. 用戶執行命令
   /fortune-tell --name "張三" --date 1990-05-15 --time 14:30 --location "台北" --gender 男 --think-harder

2. 主協調器啟動
   ├─ 驗證輸入參數
   ├─ 解析生日資訊
   └─ 識別功能旗標

3. 呼叫 Python 計算引擎（透過 Bash tool）
   python scripts/fortune-telling/calendar_converter.py \
     --date 1990-05-15 \
     --time 14:30 \
     --location "台北"

   → 返回 JSON: 農曆資訊、節氣、真太陽時等

4. 平行啟動三個專業代理（使用 Task tool）
   ├─ Task 1: 八字代理
   │   ├─ 呼叫 bazi_calculator.py
   │   ├─ 接收計算結果
   │   └─ 生成詳細解讀（使用 Sequential MCP 因為有 --think-harder）
   │
   ├─ Task 2: 紫微代理
   │   ├─ 呼叫 ziwei_calculator.py
   │   ├─ 接收計算結果
   │   └─ 生成詳細解讀（使用 Sequential MCP）
   │
   └─ Task 3: 占星代理
       ├─ 呼叫 astrology_calculator.py
       ├─ 接收計算結果
       └─ 生成詳細解讀（使用 Sequential MCP）

5. 等待所有代理完成
   [平行執行完畢後收集結果]

6. 啟動綜合協調器
   ├─ 接收三個代理的分析結果
   ├─ 應用概念映射表
   ├─ 計算各面向強度評分
   ├─ 識別一致性與差異性
   └─ 生成綜合報告（使用 Sequential MCP）

7. 如果有 --include-transit，執行流年分析
   [額外的流年分析流程]

8. 如果有 --compatibility，執行合婚分析
   [額外的配對分析流程]

9. 如果有 --date-selection，執行擇日分析
   [額外的擇日分析流程]

10. 生成完整報告
    ├─ 整合所有章節
    ├─ 套用 Markdown 格式
    └─ 加入視覺元素（表格、圖表符號）

11. 儲存到檔案（如果有 --save，預設啟用）
    ├─ 創建目錄結構
    ├─ 生成檔案名稱
    ├─ 寫入 Markdown 檔案
    └─ 更新索引

12. 如果有 --loop，提供迭代選項
    ├─ 詢問用戶是否需要調整
    ├─ 接受額外指示
    └─ 重新執行特定部分

13. 返回結果給用戶
    ├─ 在對話中顯示完整報告
    └─ 提供檔案路徑連結
```

---

### 7. 技術實現檢查清單

#### Phase 1: 基礎架構 (Week 1-2)
- [ ] 設置 Python 環境與依賴安裝
- [ ] 實現 `calendar_converter.py` 核心功能
  - [ ] 公曆轉農曆
  - [ ] 節氣計算
  - [ ] 真太陽時校正
  - [ ] 時區處理
- [ ] 實現 `bazi_calculator.py` 基本功能
  - [ ] 四柱排盤
  - [ ] 五行統計
  - [ ] 十神配置
- [ ] 實現 `ziwei_calculator.py` 基本功能
  - [ ] 十二宮定位
  - [ ] 主星安置
  - [ ] 四化計算
- [ ] 實現 `astrology_calculator.py` 基本功能
  - [ ] 行星位置計算
  - [ ] 宮位計算
  - [ ] 相位計算
- [ ] 單元測試（使用已知命例驗證準確性）

#### Phase 2: 代理系統 (Week 3-4)
- [ ] 設計八字代理 Prompt
  - [ ] 測試解讀質量
  - [ ] 優化輸出格式
- [ ] 設計紫微代理 Prompt
  - [ ] 測試解讀質量
  - [ ] 優化輸出格式
- [ ] 設計占星代理 Prompt
  - [ ] 測試解讀質量
  - [ ] 優化輸出格式
- [ ] 實現 Task tool 平行協調邏輯
- [ ] 測試三個代理平行執行

#### Phase 3: 綜合系統 (Week 5-6)
- [ ] 設計綜合協調器 Prompt
- [ ] 實現概念映射邏輯
- [ ] 實現強度評分系統
- [ ] 實現綜合報告生成
- [ ] 測試綜合分析質量

#### Phase 4: 命令整合 (Week 7)
- [ ] 創建主命令處理器
- [ ] 實現輸入驗證邏輯
- [ ] 整合所有組件
- [ ] 創建 Claude Code 命令檔案
- [ ] 端到端測試

#### Phase 5: 進階功能 (Week 8-10)
- [ ] 實現流年運勢分析
- [ ] 實現合婚配對分析
- [ ] 實現擇日選時功能
- [ ] 實現檔案儲存系統
- [ ] 實現運勢追蹤索引

#### Phase 6: 優化與完善 (Week 11-12)
- [ ] 性能優化
- [ ] 錯誤處理完善
- [ ] 文檔完善
- [ ] 使用者測試
- [ ] 迭代改進

---

### 8. 測試策略

#### 單元測試
- 每個 Python 計算模組使用已知命例驗證
- 使用專業命理網站的排盤結果作為標準答案

#### 整合測試
- 測試完整流程的執行
- 驗證代理協調正確性
- 檢查輸出格式完整性

#### 質量測試
- 邀請專業命理師評估解讀質量
- 收集用戶反饋改進
- 持續優化 Prompt

---

### 9. 預期挑戰與解決方案

#### 挑戰 1: 曆法計算準確性
**解決**: 使用成熟的開源函式庫，並用專業網站結果驗證

#### 挑戰 2: 代理解讀一致性
**解決**: 精心設計 Prompt，提供豐富的範例，使用 Sequential MCP 提高分析深度

#### 挑戰 3: 綜合分析的複雜性
**解決**: 建立清晰的概念映射表，使用結構化的評分系統

#### 挑戰 4: 性能與執行時間
**解決**: 平行執行代理，快取計算結果，優化 Python 腳本

---

### 10. 未來擴展方向

#### 短期（3-6個月）
- 加入更多命理方法（奇門遁甲、梅花易數）
- 優化綜合分析算法
- 增加更多視覺化元素

#### 中期（6-12個月）
- 開發 Web 介面（保持 Claude Code 後端）
- 建立命例資料庫與學習系統
- 加入 AI 對話式諮詢功能

#### 長期（1-2年）
- 多語言支持（簡體中文、英文）
- 社群功能（分享命盤、討論交流）
- 專業命理師工具套件

---

## 📊 專案時程估算

**總預估時間**: 12週（約3個月）

**關鍵里程碑**:
- Week 2: 完成計算引擎
- Week 4: 完成代理系統
- Week 6: 完成綜合系統
- Week 7: 完成基本命令
- Week 10: 完成進階功能
- Week 12: 完成測試與優化

**最小可行產品 (MVP)**:
- Week 7 完成基本命令後即可使用
- 包含三種方法的本命盤分析與基本綜合

---

## 🎯 成功標準

1. **準確性**: 計算結果與專業網站一致率 >99%
2. **質量**: 解讀獲得專業命理師認可
3. **完整性**: 三種方法都能生成詳細分析
4. **綜合性**: 跨方法整合提供獨特價值
5. **可用性**: 用戶能順利使用並獲得滿意結果
6. **可靠性**: 系統穩定，錯誤處理完善

---

## 📝 附錄

### A. Python 環境設置

```bash
# 創建虛擬環境
cd /Users/frank/src/life
python3 -m venv venv
source venv/bin/activate

# 安裝依賴
pip install -r scripts/fortune-telling/requirements.txt

# 驗證安裝
python scripts/fortune-telling/test_imports.py
```

### B. Claude Code 命令文件結構

```markdown
# .claude/commands/fortune-tell.md

---
name: fortune-tell
description: 專業命理分析系統 - 整合八字、紫微、占星三種方法
category: personal
---

[命令實現內容將在 Phase 4 完成後填入]
```

### C. 範例命令執行

```bash
# 基本分析
/fortune-tell --name "張三" --date 1990-05-15 --time 14:30 --location "台北" --gender 男

# 深度分析 + 流年
/fortune-tell --name "張三" --date 1990-05-15 --time 14:30 --location "台北" --gender 男 --think-harder --include-transit

# 完整分析（所有功能）
/fortune-tell --name "張三" --date 1990-05-15 --time 14:30 --location "台北" --gender 男 --think-harder --loop --include-transit --save
```

---

## ✨ 結語

這是一個雄心勃勃但完全可行的專案。透過 Claude Code 的自然語言能力、Python 的計算準確性、以及精心設計的代理協調系統，我們可以創造出一個獨特且專業的命理分析工具。

關鍵成功因素：
1. 專業級的計算準確性
2. 高質量的代理解讀
3. 有價值的跨方法綜合
4. 清晰的結構化輸出

讓我們開始實現這個專案！ 🚀

---

**文件版本**: 1.0
**最後更新**: 2025-10-26
**作者**: Claude Code SuperClaude Framework
